name: "Database change notifier"

on:
  pull_request:
    branches: [main]
    paths:
      - "**/migrations/**"

permissions:
  contents: read
  pull-requests: write

jobs:
  migration-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 #v6.0.1 release
        with:
          fetch-depth: 0
          repository: dennisqogita/django-project
          path: canary
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get changed migration files
        id: changed_files
        run: |
          cd canary
          FILES=$(git diff --name-only \
            ${{ github.event.pull_request.base.sha }} \
            ${{ github.event.pull_request.head.sha }} \
            -- '**/migrations/**' -- ':(exclude)**/__pycache__/**')

          {
            echo "FILES<<EOF"
            echo "$FILES"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Run database change parser
        run: |
          cd canary
          python migration_check.py $FILES

      - name: Get body of PR
        run: |
          echo "PR BODY:"
          echo ${{ github.event.pull_request.body }}

      # - name: Read PR description
      #   uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd #v8 release
      #   with:
      #     script: |
      #       const { owner, repo } = context.repo;
      #       const issue_number = context.payload.pull_request.number;

      #       const comments = await github.rest.issues.listComments({
      #         owner,
      #         repo,
      #         issue_number,
      #         per_page: 100,
      #       });

      #       if (comments.data.length === 0) {
      #         core.setFailed('No comments found on PR');
      #         return;
      #       }

      #       // Comments are returned oldest â†’ newest
      #       const firstComment = comments.data[0];

      #       console.log('First comment author:', firstComment.user.login);
      #       console.log('First comment body:\n', firstComment.body);

      #       core.setOutput('first_comment_body', firstComment.body);

      # - name: Echo migration changes
      #   run: echo $MIGRATION_CHANGES | jq .

      # - name: Build migration message body
      #   run: |
      #     node <<'EOF'
      #     const migrationChanges = JSON.parse(process.env.MIGRATION_CHANGES);

      #     const isArrayEmpty = (arr) => !Array.isArray(arr) || arr.length == 0;

      #     const statusText = (status) => {
      #       switch (status) {
      #         case -1: return "deleted";
      #         case 0: return "modified";
      #         case 1: return "created";
      #         default: "return unknown"
      #       }
      #     };

      #     let body = "";

      #     for (const [model, changes] of Object.entries(migrationChanges)) {
      #       body += `**${model}** (${statusText(changes.status)})`;
      #       if (changes.renamed_from) body += ` &larr; renamed from **${changes.renamed_from}**`
      #       body += "\n";

      #       if (!isArrayEmpty(changes.added)) body += `&ndash; Added: ${changes.added.join(", ")}\n`;
      #       if (!isArrayEmpty(changes.removed)) body += `&ndash; Removed: ${changes.removed.join(", ")}\n`;

      #       const renamedEntries = Object.entries(changes.renamed || {});
      #       if (renamedEntries.length > 0) {
      #         body += `&ndash; Renamed: ${renamedEntries.map(([oldName, newName]) => oldName + " &rarr; " + newName).join(", ")}\n`
      #       }

      #       body += "\n";
      #     }

      #     const fs = require("fs");
      #     fs.appendFileSync(process.env.GITHUB_ENV, `MIGRATION_BODY<<EOF\n${body}\nEOF\n`);
      #     EOF

      # - name: Add GitHub comment with changes
      #   uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd #v8 release
      #   with:
      #     script: |
      #       const migrationChanges = JSON.parse(process.env.MIGRATION_CHANGES)

      #       const isArrayEmpty = (arr) => !Array.isArray(arr) || arr.length === 0;

      #       const statusText = (status) => {
      #         switch (status) {
      #           case -1: return "deleted";
      #           case 0: return "modified";
      #           case 1: return "created";
      #           default: return "unknown";
      #         }
      #       };

      #       const header = "## :warning: Migration Changes Detected\n\nThe following models were affected in this PR.\n\n";
      #       const body = header + process.env.MIGRATION_BODY;

      #       await github.rest.issues.createComment({
      #         owner: context.repo.owner,
      #         repo: context.repo.repo,
      #         issue_number: context.issue.number,
      #         body: body
      #       })
